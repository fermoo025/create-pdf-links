<!DOCTYPE html>
<html>
    <head>
        <title>POST to GAS with Retry</title>
    </head>
    <body>
        <h2>Enter your data:</h2>
        <form method="POST">
            <table>
                <tr>
                    <td><label for="appId">App ID</label></td>
                    <td><input type="text" name="appId" id="appId"  size="100"
                            value="AKfycbwM5zKfSCh7Rx4S3uu7fGxE98xT8K8zWUgIQMszA0M6AH9xiMxMMKu9ExPFiA98YD70mQ"
                            required></td>
                </tr>
                <tr>
                    <td><label for="folderId">Folder ID</label></td>
                    <td><input type="text" name="folderId" id="folderId"  size="100"
                            value="1T6p8TBxikn8LIYrilCTxaplqwF9nfVGB"
                            required></td>
                </tr>
                <tr>
                    <td><label for="subFolders">Sub Folders</label></td>
                    <td><input type="text" name="subFolders" id="subFolders"  size="100"
                            value="250612 250614" required></td>
                </tr>
                <tr>
                    <td><label for="sheetId">Sheet ID</label></td>
                    <td><input type="text" name="sheetId" id="sheetId"  size="100"
                            value="1CVAAilMvM8LsrZIelRz6nf4SRvFeoawGonw6L4QlSC8"
                            required></td></tr>
                <tr>
                    <td><label for="tabName">Tab Name</label></td>
                    <td><input type="text" name="tabName" id="tabName"  value="2506"
                            required></td>
                </tr>
            </table>
        </form>
        <button onclick="convert()">Send Request</button>
        <p id="status">Status: Idle</p>
        <h3>Message:</h3>
        <textarea id="result" style="width:500px; height: 400px; "></textarea>

        <script>
            let timeoutHandle = null;
            function addMsg(m){
                document.getElementById('result').innerText += m+'\n';
            }       

            function convert() {
                document.getElementById('status').textContent = 'Status: Sending...';
                sendRequest();
            }

            function sendRequest() {
                const appId=document.getElementById('appId').value.trim();
                const folderId = document.getElementById('folderId').value.trim();
                const subFolders = document.getElementById('subFolders').value.trim();
                const sheetId = document.getElementById('sheetId').value.trim();
                const tabName = document.getElementById('tabName').value.trim();
                const webAppUrl = `https://script.google.com/macros/s/${appId}/exec`; // Replace with your Web App URL

                const payload = { folderId, subFolders, sheetId, tabName };
                const TIMEOUT_MS = 330000; // 330 seconds
                const RETRY_DELAY_MS = 5000; // retry every 5 seconds
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), TIMEOUT_MS);
                timeoutHandle = timeout;

                fetch(webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                })
                .then(res => res.text())
                .then(result => {
                    addMsg('Response:', result);
                    if (result.trim() === 'done') {
                        document.getElementById('status').textContent = 'Status: Done!';
                    } else {
                        document.getElementById('status').textContent = 'Status: Yet, retrying...';
                        setTimeout(sendRequest, RETRY_DELAY_MS);
                    }
                })
                .catch(err => {
                    if (err.name === 'AbortError') {
                        addMsg('Request timed out, treating as yet.');
                    } else {
                        addMsg('Error:', err);
                    }
                    document.getElementById('status').textContent = 'Status: Yet (timeout), retrying...';
                    setTimeout(sendRequest, RETRY_DELAY_MS);
                });
            }
        </script>
    </body>
</html>
